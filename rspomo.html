<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>rsPomodoro WASM</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #timer { font-size: 2em; font-weight: bold; margin: 20px 0; }
        button { padding: 10px 20px; font-size: 16px; }
        input, select { padding: 8px; margin: 5px; }
    </style>
</head>
<body>
    <div id="app">
        <h1>rsPomodoro Timer üçÖ</h1>
        <input type="number" id="timeInput" value="5" min="1">
        <select id="unitSelect">
            <option value="Seconds">Seconds</option>
            <option value="Minutes" selected>Minutes</option>
        </select>
        <button id="startBtn">Start Timer</button>
        <div id="status"></div>
        <div id="timer">Ready to start!</div>
    </div>

    <script type="module">
        import init, { WasmPomodoroTimer, WasmTimeUnits } from './pkg/rsPomodoro.js';


        function createChime() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Create a simple bell-like chime
            const playChime = () => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Bell-like frequencies
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.5);
                
                // Fade out
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            };
            
            return playChime;
        }

        async function run() {
            try {
                await init();
                console.log("WASM module loaded successfully");

                const timeInput = document.getElementById('timeInput');
                const unitSelect = document.getElementById('unitSelect');
                const startBtn = document.getElementById('startBtn');
                const status = document.getElementById('status');
                const timerDisplay = document.getElementById('timer');
                const playChime = createChime();

                let currentTimer = null;
                let intervalId = null;

                startBtn.addEventListener('click', () => {
                    try {
                        console.log("Start button clicked");
                        
                        // Clear any existing interval
                        if (intervalId) {
                            clearInterval(intervalId);
                        }

                        const timeValue = parseInt(timeInput.value);
                        const timeUnit = unitSelect.value === 'Minutes' 
                            ? WasmTimeUnits.Minutes 
                            : WasmTimeUnits.Seconds;

                        console.log(`Creating timer: ${timeValue} ${unitSelect.value}`);

                        currentTimer = new WasmPomodoroTimer(timeValue, timeUnit);
                        currentTimer.start();

                        startBtn.disabled = true;
                        status.textContent = 'Timer running...';

                        intervalId = setInterval(() => {
                            try {
                                const remaining = currentTimer.get_remaining_time();
                                console.log(`Remaining: ${remaining}`);
                                
                                const minutes = Math.floor(remaining / 60);
                                const seconds = remaining % 60;
                                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                                if (currentTimer.is_finished()) {
                                    playChime();
                                    console.log("Timer finished!");
                                    clearInterval(intervalId);
                                    status.textContent = 'Timer finished! üéâ';
                                    startBtn.disabled = false;
                                    timerDisplay.textContent = 'Ready to start!';
                                    
                                    
                                    setTimeout(() => {
                                        alert('Pomodoro session complete! üçÖ');
                                    }, 1000);
                                }
                            } catch (error) {
                                console.error("Error in timer interval:", error);
                            }
                        }, 1000);

                    } catch (error) {
                        console.error("Error starting timer:", error);
                        status.textContent = 'Error starting timer';
                    }
                });

            } catch (error) {
                console.error("Failed to load WASM module:", error);
                document.getElementById('status').textContent = 'Failed to load timer module';
            }
        }

        run();
    </script>
</body>
</html>